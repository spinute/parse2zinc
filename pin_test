#!/bin/sh
PHOME=~/Dropbox/program/parse2zinc

ANS=$PHOME/tmp/answer
SOLVE=$PHOME/bin/opti_main
BENCH=$PHOME/benchmarks

FD_HOME=~/1123fast

TRANSRATE=$FD_HOME/src/translate/translate.py 
VAL=$FD_HOME/src/VAL/validate

directories=(`cat $PHOME/experiment/all_dirs.txt`)
domains=(`cat $PHOME/experiment/all_doms.txt`)
problems=(`cat $PHOME/experiment/all_probs.txt`)

RESULT="result-`date '+%y-%m-%d-%H'`"
mkdir -p $PHOME/$RESULT
git add $RESULT

git commit -m 'experiment: 1s, gurobi, 4core'
for (( j = 0; j < 868; j++ )); do
	dir=${directories[$i]}
	dom=$BENCH/$dir/${domains[$i]}
	prob=$BENCH/$dir/${problems[$i]}

	VAL_RESULT=$PHOME/${RESULT}/val_${dir}_${domains[$i]}_${problems[$i]}

	$TRANSRATE $dom $prob ## --relaxed -> remove negative effect
	mv output.sas $PHOME/tmp
	TESTLOG=$PHOME/$RESULT/testlog

	echo "$THISDOM: $PROBX" >> $TESTLOG

	timeout 1s bash -c '
	    trap "echo timeout error >> $TESTLOG; exit 1" SIGALRM

		$SOLVE $PHOME/tmp/output.sas
		$VAL $dom $prob $ANS > $VAL_RESULT
		echo $VAL_RESULT | $PHOME/bin/check_valid >> $TESTLOG
	'

	###### compare with fastdownward result
	$FD_HOME/src/preprocess/preprocess < $PHOME/tmp/output.sas
	echo "ffffffffffastdownward!!!!!!!!!!" >> $TESTLOG

	timeout 1s bash -c'{
	    trap "echo timeout error >> $TESTLOG; exit 1" SIGALRM

		$FD_HOME/src/fast-downward.py output --search "astar(lmcut())" 

		if [ -f $PHOME/objval ]; then
			mv $PHOME/sas_plan $PHOME/output $PHOME/objval $PHOME/tmp
			$PHOME/script/get_planValue $THISDOM $PROBX >> $TESTLOG
		fi
	}'

	echo `date`>> $TESTLOG

	###### 実験はmasterからやろう

	if [ -f $PHOME/sas_plan.* ]; then
		mv $PHOME/sas_plan.* $PHOME/tmp
	fi

done;
git commit -am 'autocommit for fin test'